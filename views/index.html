<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PW Zendesk Integration</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pw-app-sdk@0.1.2/dist/pwsdk.min.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">

</head>
<body>
	<script>

		var person = {
			email : ''
		};

		var zenCard;
		var red = '#B22222';
		var teal = '#46B6AC';

		try {
			debugger;
			var pwSdkObj = PWSDK.init();
		} catch(err) {
			console.log(err);	
		}

		$(function() {
			if (pwSdkObj) {
				pwSdkObj.setAppUI({height: 300	});
				pwSdkObj.getContext().then(function(data) {
					person.email = data.context.primary_email;
					fetchZendeskTickets();
					console.log('CONTEXT OBJECT:' + data.context);
				});
			}

			zenTicketsList = new Vue({
				el: '#zenTicketsList',
				data: {
				items: [],
				status: 'new'
				}
			})

			function capitalizeFirstLetter(string) {
				return string.charAt(0).toUpperCase() + string.slice(1);
			}

			function fetchZendeskTickets(){
				$.ajax({
				type: 'GET',
				dataType: 'json',
				data: person,
				url: '/zeninfo',
				success: function(result) {
					debugger;
					console.log(result);
					zenTicketsList.status = 'hasTickets';
					zenTicketsList.items = [];
					$.each(result, function(index){
						var p = capitalizeFirstLetter(result[index].priority);
						var t = capitalizeFirstLetter(result[index].type);
						var url = result[index].url.replace('/api/v2', '').replace('.json','');
						var s;
						if(p == 'Urgent'){
							s = 'mdl-card__title mdl-card--expand mdl-card__title-red';
						} else {
							s = 'mdl-card__title mdl-card--expand';
						}
						zenTicketsList.items.push({
							subject : result[index].raw_subject, 
							priority : p, 
							url : result[index].url, 
							st : s,
							type : t,
							description : result[index].description,
							tags : result[index].tags,
							url : url
						});

					});
				},

				error: function(result) {
					console.log(result);
					zenTicketsList.status = 'error';
				}

				});
			}
		});

	</script>

	<!-- Square card -->
	<style>

		.demo-card-square.mdl-card {
		  width: 100%;
		  margin: auto;
		}

	</style>

	<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
		<header class="mdl-layout__header">
			    <div class="mdl-layout__header-row">
				    <!-- Title -->
				    <span class="mdl-layout-title">Zendesk Tickets</span>
				    <!-- Add spacer, to align navigation to the right -->
				    <div class="mdl-layout-spacer"></div>
				    <!-- Navigation. We hide it in small screens. -->
				    <nav class="mdl-navigation mdl-layout--large-screen-only">
				    <!--<a class="mdl-navigation__link" href="">Link</a>-->
				    </nav>
			    </div>
		</header>
		<!--<div class="mdl-layout__drawer">
		    <span class="mdl-layout-title">Title</span>
		    <nav class="mdl-navigation">
			    <a class="mdl-navigation__link" href="">Link</a>
			    <a class="mdl-navigation__link" href="">Link</a>
			    <a class="mdl-navigation__link" href="">Link</a>
			    <a class="mdl-navigation__link" href="">Link</a>
		    </nav>
		</div>-->
		<main id="zenTicketsList" class="mdl-layout__content">
				<div v-if="status === 'new'">
					<div class="demo-card-square mdl-card mdl-shadow--2dp">
					  <div class="mdl-card__title">
					    <h2 class="mdl-card__title-text">Fetching Zendesk Tickets</h2>
					  </div>
					  <div class="mdl-card__supporting-text">
					    This may take a moment.
					    <div id="p2" class="mdl-progress mdl-js-progress mdl-progress__indeterminate"></div>
					  </div>
					</div>
				</div>

				<ul style="margin:0px;" class="mdl-list" v-if="status === 'hasTickets' && items.length">
					<li class="mdl-list__item mdl-list__item--three-line" v-for="item in items">
						<span class="mdl-list__item-primary-content">
							    <span><a :href="item.url" target="_blank">{{item.subject}}</a> {{ item.priority }} {{ item.type }}</span>
							    <span class="mdl-list__item-text-body">{{item.description}}</span>
						</span>
					</li>
				</ul>

				<div v-else-if="status === 'hasTickets'">
					<span>There are no tickets to display</span>
				</div>
				<div v-else-if="status === 'error'">
					<span>There has been an error retrieving the Zendesk Data</span>
				</div>

		</main>
	</div>
	<div>
	<button>Display Ticket Info</button>
	</div>
</body>
</html>




